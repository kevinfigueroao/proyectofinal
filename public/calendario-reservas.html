<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Calendario de Reservas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
    <!-- Bootstrap para el modal y formularios -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/calendario-reservas.css">
    <style>
      
    </style>
</head>

<body>
    <!-- BARRA SUPERIOR -->
    <nav class="navbar-superior">
        <div class="navbar-izquierda">
            <button type="button" class="btn-nav" onclick="location.href='estadisticas.html'">Estadísticas
                Reservas</button>
            <button type="button" class="btn-nav" onclick="location.href='reportes.html'">Reportes Reservas</button>
        </div>
        <div class="navbar-derecha">
            <button class="logout-btn" id="btnLogout">Cerrar sesión</button>
        </div>
    </nav>

    <div class="container">
        <center>
            <h1 id="tituloCalendario">Calendario de Reservas</h1>
        </center>
        <div class="filtros-barra" id="filtroSucursalBarra" style="display:none;">
            <label for="sucursalFiltro">Sucursal:</label>
            <select id="sucursalFiltro"></select>
            <button id="verCalendarioBtn">
                <svg height="18" width="18" viewBox="0 0 20 20" fill="none">
                    <rect width="20" height="20" fill="none" />
                    <path
                        d="M6 2V4M14 2V4M3 8.5H17M5 6H15C16.1046 6 17 6.89543 17 8V16C17 17.1046 16.1046 18 15 18H5C3.89543 18 3 17.1046 3 16V8C3 6.89543 3.89543 3 5 6Z"
                        stroke="#fff" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                Ver calendario
            </button>
        </div>

        <div class="input-group mb-4" style="max-width:400px; margin:auto;">
  <input type="text" id="buscadorReservas" class="form-control" placeholder="Buscar por RUT, nombre trabajador o empresa...">
  <span class="input-group-text">
    <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
      <circle cx="9" cy="9" r="7" stroke="#2866c7" stroke-width="2"/>
      <line x1="15.1" y1="15.1" x2="18.5" y2="18.5" stroke="#2866c7" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </span>
</div>

        <div id="calendar"></div>

        <!-- Modal para el detalle de reserva -->
        <div id="modalReserva" class="modal-reserva">
            <div class="modal-reserva-content">
                <span class="modal-reserva-close" id="cerrarModalReserva">&times;</span>
                <div id="modalDetalleBody"></div>
            </div>
        </div>
        <!-- Modal para editar reserva (formulario avanzado) -->
        <div id="modalEditarReserva" class="modal-reserva" tabindex="-1">
            <div class="modal-reserva-content" style="max-width:900px;">
                <span class="modal-reserva-close" id="cerrarModalEditarReserva">&times;</span>
                <div id="modalEditarBody"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/es.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const apiUrl = "http://localhost:3000/api";
        let reservas = [];
        let reservasPorId = {};
        let calendar = null;
        let sucursales = [];
        let sucursalActualId = null;

        if (!sessionStorage.getItem('token')) window.location.href = 'login.html';
        document.getElementById('btnLogout').onclick = function () {
            sessionStorage.removeItem('token');
            window.location.href = 'login.html';
        };

        function obtenerUsuarioActual() {
            const token = sessionStorage.getItem('token');
            if (!token) return null;
            try {
                const payload = token.split('.')[1];
                const decoded = JSON.parse(atob(payload));
                if (decoded.exp && (Date.now() / 1000) > decoded.exp) {
                    sessionStorage.removeItem('token');
                    return null;
                }
                return decoded;
            } catch (e) { return null; }
        }

        function actualizarTituloCalendario(nombreSucursal) {
            document.getElementById('tituloCalendario').textContent = `Calendario de ${nombreSucursal}`;
        }

        async function fetchSucursales() {
            const token = sessionStorage.getItem('token');
            const res = await fetch(apiUrl + "/catalogos/sucursales", {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            sucursales = await res.json();
            const select = document.getElementById('sucursalFiltro');
            select.innerHTML = '<option value="">Seleccione...</option>' +
                sucursales.map(s => `<option value="${s.id}">${s.nombre}</option>`).join('');
        }

        async function fetchReservas(sucursalId) {
            const token = sessionStorage.getItem('token');
            const res = await fetch(apiUrl + '/reservas', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.status === 401) {
                alert("Tu sesión ha expirado. Debes iniciar sesión nuevamente.");
                sessionStorage.removeItem('token');
                window.location.href = 'login.html';
                return;
            }
            const data = await res.json();
            reservas = data.filter(r => String(r.sucursalId) === String(sucursalId));
            reservasPorId = {};
            for (const r of reservas) reservasPorId[r.id] = r;
        }

        // Buscador de reservas por RUT, nombre trabajador o empresa
document.getElementById('buscadorReservas').addEventListener('input', function () {
    const filtro = this.value.trim().toLowerCase();
    let filtradas = reservas;

    if (filtro.length > 0) {
        filtradas = reservas.filter(r => {
            // Buscar en empresa
            const empresaNombre = r.empresa?.nombre?.toLowerCase() || '';
            const empresaRut = r.empresa?.rut?.toLowerCase() || '';
            // Buscar en todos los trabajadores
            const trabajadores = (r.reservasTrabajador || []).map(rt => ({
                nombre: rt.trabajador?.nombre?.toLowerCase() || '',
                rut: rt.trabajador?.rutPasaporte?.toLowerCase() || ''
            }));
            // Si coincide con empresa
            if (empresaNombre.includes(filtro) || empresaRut.includes(filtro)) return true;
            // Si coincide con algún trabajador
            for (const t of trabajadores) {
                if (t.nombre.includes(filtro) || t.rut.includes(filtro)) return true;
            }
            return false;
        });
    }

    // Renderiza el calendario solo con las reservas filtradas
    renderCalendarFiltrado(filtradas);
});

// Versión de render solo con el listado filtrado
function renderCalendarFiltrado(lista) {
    const eventos = lista.map(r => ({
        id: String(r.id),
        title: (r.tipoReserva === 'empresa' && r.empresa?.nombre)
            ? r.empresa.nombre
            : (r.tipoReserva === 'particular' && r.reservasTrabajador?.[0]?.trabajador?.nombre)
                ? r.reservasTrabajador[0].trabajador.nombre
                : 'Reserva',
        start: r.fechaHora,
        classNames: [classReserva(r)]
    }));

    const calendarEl = document.getElementById('calendar');
    calendarEl.innerHTML = '';

    calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'es',
        initialView: 'dayGridMonth',
        events: eventos,
        eventClick: function (info) {
            mostrarDetalleReserva(reservasPorId[info.event.id]);
        },
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listMonth'
        },
        buttonText: {
            today: 'hoy',
            month: 'mes',
            week: 'semana',
            list: 'lista'
        },
        eventDidMount: function (info) {
            info.el.title = "Click para ver detalle";
        }
    });
    calendar.render();
}


        function classReserva(reserva) {
            if (reserva.estado === 'completado') return 'fc-event-completado';
            if (reserva.estado === 'cancelado' || reserva.estado === 'cancelada') return 'fc-event-cancelado';
            return 'fc-event-pendiente';
        }

        function renderCalendar(sucursalId, nombreSucursal) {
            sucursalActualId = sucursalId;
            const eventos = reservas.map(r => ({
                id: String(r.id),
                title: (r.tipoReserva === 'empresa' && r.empresa?.nombre)
                    ? r.empresa.nombre
                    : (r.tipoReserva === 'particular' && r.reservasTrabajador?.[0]?.trabajador?.nombre)
                        ? r.reservasTrabajador[0].trabajador.nombre
                        : 'Reserva',
                start: r.fechaHora,
                classNames: [classReserva(r)]
            }));

            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = '';

            calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'es',
                initialView: 'dayGridMonth',
                events: eventos,
                eventClick: function (info) {
                    mostrarDetalleReserva(reservasPorId[info.event.id]);
                },
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listMonth'
                },
                buttonText: {
                    today: 'hoy',
                    month: 'mes',
                    week: 'semana',
                    list: 'lista'
                },
                eventDidMount: function (info) {
                    info.el.title = "Click para ver detalle";
                }
            });

            calendar.render();
            actualizarTituloCalendario(nombreSucursal);
        }

        function mostrarDetalleReserva(reserva) {
            let html = `<h3>Reserva #${reserva.id}</h3>
    <b>Tipo:</b> ${reserva.tipoReserva}<br>
    <b>Sucursal:</b> ${reserva.sucursal?.nombre || ''}<br>
    <b>Fecha:</b> ${new Date(reserva.fechaHora).toLocaleString()}<br>
    <hr>`;

            if (reserva.tipoReserva === 'empresa') {
                html += `<b>Trabajadores:</b>
        <ul style="padding-left:1.2em;">
        ${(reserva.reservasTrabajador || []).map(rt => `
            <li style="margin-bottom:7px;">
            <b>Nombre:</b> ${rt.trabajador?.nombre || ''} -
            <b>RUT/Pasaporte:</b> ${rt.trabajador?.rutPasaporte || ''} -
            <b>Cargo:</b> ${rt.cargo}
            <b>Edad:</b> ${rt.edad}
            ${(reserva.estado === 'cancelado' || reserva.estado === 'cancelada')
                        ? ''
                        : (rt.asistio
                            ? ' <span class="badge bg-success ms-2" style="font-size:0.98em;">Asistió</span>'
                            : ` <button class="btn btn-sm btn-outline-success ms-2" onclick="marcarAsistencia(${reserva.id},${rt.trabajadorId},this)">
                            <span style="font-size:1em;"><b>✔</b></span> Marcar asistencia
                        </button>`
                        )
                    }
            </li>
        `).join('')}
        </ul>
        <hr>`;
            }

            if (reserva.tipoReserva === 'particular') {
                const t = reserva.reservasTrabajador && reserva.reservasTrabajador[0];
                html += `<b>Datos:</b><br>`;
                if (t) {
                    html += `
                <strong>Nombre:</strong> ${t.trabajador?.nombre ?? ''}<br>
                <strong>RUT/Pasaporte:</strong> ${t.trabajador?.rutPasaporte ?? ''}<br>
                <strong>Edad:</strong> ${t.edad ?? '-'}<br>
                <strong>Cargo:</strong> ${t.cargo ?? '-'}<br>
                ${t.correo ? '<strong>Correo:</strong> ' + t.correo + '<br>' : ''}
                ${(reserva.estado === 'cancelado' || reserva.estado === 'cancelada')
                            ? ''
                            : (t.asistio
                                ? '<span class="badge bg-success ms-2" style="font-size:0.98em;">Asistió</span>'
                                : ` <button class="btn btn-sm btn-outline-success ms-2" onclick="marcarAsistencia(${reserva.id},${t.trabajadorId},this)">
                                <span style="font-size:1em;"><b>✔</b></span> Marcar asistencia
                            </button>`
                            )
                        }
            `;
                }
                html += `<hr>`;
            }

            html += `<b>Estado de la reserva:</b> <span style="font-weight:bold;color:#222;">${reserva.estado}</span>`;

            if (reserva.tipoReserva === 'empresa') {
                html += `<hr>
        <strong>Empresa:</strong> ${reserva.empresa?.nombre || '-'}<br>
        <strong>RUT:</strong> ${reserva.empresa?.rut || '-'}<br>
        <strong>Dirección:</strong> ${reserva.empresa?.direccion || '-'}<br>
        <strong>Giro:</strong> ${reserva.empresa?.giro || '-'}<br><br>
        <strong>Solicitante:</strong> ${reserva.solicitante?.nombre || '-'}<br>
        <strong>Cargo:</strong> ${reserva.solicitante?.cargo || '-'}<br>
        <strong>Teléfono:</strong> ${reserva.solicitante?.telefono || '-'}<br>
        <strong>Correo:</strong> ${reserva.solicitante?.correo || '-'}<br><br>
        `;
            }
            if (reserva.bateriasMedicas?.length) {
                html += `<br><strong>Baterías Médicas:</strong> ${reserva.bateriasMedicas.map(b => b.nombre).join(', ')}`;
            }
            if (reserva.examenesAdicionales?.length) {
                html += `<br><strong>Exámenes Adicionales:</strong> ${reserva.examenesAdicionales.map(e => e.nombre).join(', ')}`;
            }
            if (reserva.pruebasDrogas?.length) {
                html += `<br><strong>Pruebas de Drogas:</strong> ${reserva.pruebasDrogas.map(p => p.nombre).join(', ')}`;
            }

           

// Agrega los botones solo si NO está completada ni cancelada
if (reserva.estado !== "completado" && reserva.estado !== "cancelado" && reserva.estado !== "cancelada") {
  html += `
    <div style="margin-top:18px; text-align:right;">
      <a class="btn btn-outline-primary me-2" href="editar-reserva.html?id=${reserva.id}">
        ✏️ Modificar
      </a>
      <button class="btn btn-outline-danger" onclick="cancelarReserva(${reserva.id})">
        🗑️ Cancelar
      </button>
    </div>
  `;
}

            document.getElementById('modalDetalleBody').innerHTML = html;
            document.getElementById('modalReserva').style.display = "block";
        }

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('cerrarModalReserva').onclick = function () {
                document.getElementById('modalReserva').style.display = "none";
            };
        });

        async function cancelarReserva(reservaId) {
            if (!confirm("¿Estás seguro que deseas cancelar esta reserva?")) return;
            const token = sessionStorage.getItem('token');
            const res = await fetch(`${apiUrl}/reservas/${reservaId}/cancelar`, {
                method: 'PATCH',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) {
                alert("Reserva cancelada correctamente.");
                document.getElementById('modalReserva').style.display = "none";
                await fetchReservas(sucursalActualId);
                const nombreSucursal = sucursales.find(s => String(s.id) === String(sucursalActualId))?.nombre || '';
                renderCalendar(sucursalActualId, nombreSucursal);
            } else {
                alert("No se pudo cancelar la reserva.");
            }
        }
        window.cancelarReserva = cancelarReserva;



        document.getElementById('cerrarModalEditarReserva').onclick = function () {
            document.getElementById('modalEditarReserva').style.display = "none";
        };

        async function marcarAsistencia(reservaId, trabajadorId, btn) {


            const token = sessionStorage.getItem('token');
            const res = await fetch(`${apiUrl}/reservas/${reservaId}/trabajadores/${trabajadorId}/asistio`, {
                method: 'PATCH',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) {
                btn.outerHTML = '<span class="badge bg-success ms-2">Asistió</span>';
                const detalle = await fetch(`${apiUrl}/reservas/${reservaId}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                }).then(r => r.json());
                mostrarDetalleReserva(detalle);
                await fetchReservas(sucursalActualId);
                const nombreSucursal = sucursales.find(s => String(s.id) === String(sucursalActualId))?.nombre || '';
                renderCalendar(sucursalActualId, nombreSucursal);
            }
        }
        window.marcarAsistencia = marcarAsistencia;

        document.addEventListener('DOMContentLoaded', async function () {
            const user = obtenerUsuarioActual();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            await fetchSucursales();

            if (user.rol === 'admin') {
                document.getElementById('filtroSucursalBarra').style.display = '';
                document.getElementById('verCalendarioBtn').addEventListener('click', async () => {
                    const sucursalId = document.getElementById('sucursalFiltro').value;
                    if (!sucursalId) {
                        alert("Selecciona una sucursal para ver el calendario.");
                        return;
                    }
                    const sucursalNombre = document.getElementById('sucursalFiltro').selectedOptions[0].textContent;
                    await fetchReservas(sucursalId);
                    renderCalendar(sucursalId, sucursalNombre);
                });
            } else {
                const sucursalId = user.sucursalId;
                const sucursal = sucursales.find(s => String(s.id) === String(sucursalId));
                const nombreSucursal = sucursal ? sucursal.nombre : 'Sucursal';
                await fetchReservas(sucursalId);
                renderCalendar(sucursalId, nombreSucursal);
            }
        });
    </script>
</body>

</html>