<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editar Reserva</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-5">
    <h2>Editar Reserva</h2>
    <form id="formEditarReserva">
      <div class="mb-3">
        <label for="tipoReserva" class="form-label">Tipo de Reserva</label>
        <input type="text" class="form-control" id="tipoReserva" readonly>
      </div>
       <div class="mb-3">
        <label for="sucursal" class="form-label">Sucursal</label>
        <input type="text" class="form-control" id="sucursal" readonly>
      </div>
      <div class="mb-3">
        <label for="fechaHora" class="form-label">Fecha</label>
        <input type="date" class="form-control" id="fechaHora" required>
      </div>
       <div class="mb-3">
        <label for="hora" class="form-label">Hora</label>
        <input type="time" class="form-control" id="hora" required>
      </div>
      <div class="mb-3">
        <h3>Datos Solicitante</h3>
        <label for="nombreSolicitante" class="form-label">Nombre Solicitante</label>
        <input type="text" class="form-control" id="nombreSolicitante" readonly>
      </div>
      <div class="mb-3">
        <label for="correoSolicitante" class="form-label">Correo Solicitante</label>
        <input type="text" class="form-control" id="correoSolicitante" readonly>
      </div>
      <div class="mb-3">
        <label for="empresaSolicitante" class="form-label">Empresa Solicitante</label>
        <input type="text" class="form-control" id="empresaSolicitante" readonly>
      </div>
      <h4>Trabajadores</h4>
      <div id="trabajadoresContainer"></div>

<div class="mb-3">
  <label for="bateriasMedicas" class="form-label">Baterias Medicas</label>
<select id="bateriasMedicas" class="form-select" multiple required></select>
</div>
<div class="mb-3">
<label for="examenesAdicionales" class="form-label">Examenes Adionales</label>
<select id="examenesAdicionales" class="form-select" multiple required></select>
</div>

<div class="mb-3">
<label for="pruebasDrogas" class="form-label">Pruebas Drogas</label>
<select id="pruebasDrogas" class="form-select" multiple required></select>
</div>
<button type="submit" class="btn btn-primary">Guardar Cambios</button>
<button type="button" class="btn btn-secondary" id="btnCancelar">Cancelar</button>
    </form>
  </div>

<template id="trabajadorTemplate">
    <div class="trabajador-item border p-2 mb-2">
      <input type="hidden" class="trabajador-id">
      <div class="row">
        <div class="col">
          <label>Nombre</label>
          <input type="text" class="form-control trabajador-nombre">
        </div>
        <div class="col">
          <label>RUT</label>
          <input type="text" class="form-control trabajador-rut">
        </div>
        <div class="col">
          <label>Cargo</label>
          <input type="text" class="form-control trabajador-cargo">
        </div>
        <div class="col">
          <label>Edad</label>
          <input type="number" class="form-control trabajador-edad">
        </div>
        <div class="col">
          <label>Correo</label>
          <input type="email" class="form-control trabajador-correo">
        </div>
        <div class="col-auto d-flex align-items-end">
          <button type="button" class="btn btn-danger btn-sm remove-trabajador">X</button>
        </div>
      </div>
    </div>
  </template>
</body>
</html>

  <script>
   document.addEventListener("DOMContentLoaded", () => {
  const reservaId = new URLSearchParams(window.location.search).get("id");
  if (!reservaId) return alert("ID de reserva no especificado.");

    const tipoReserva = document.getElementById("tipoReserva");
    const fechaHora = document.getElementById("fechaHora");
    const hora = document.getElementById("hora");
    const sucursal = document.getElementById("sucursal");
    const nombreSolicitante = document.getElementById("nombreSolicitante");
    const correoSolicitante = document.getElementById("correoSolicitante");
    const empresaSolicitante = document.getElementById("empresaSolicitante");
    const trabajadoresContainer = document.getElementById("trabajadoresContainer");
    const bateriasMedicas = document.getElementById("bateriasMedicas");
    const examenesAdicionales = document.getElementById("examenesAdicionales");
    const pruebasDrogas = document.getElementById("pruebasDrogas");

  async function cargarOpcionesSelect(url, selectElement, seleccionados = []) {
  const res = await fetch(url);
  const items = await res.json();
  selectElement.innerHTML = ""; 

  items.forEach(item => {
    const option = document.createElement("option");
    option.value = item.id;
    option.textContent = item.nombre;
    if (seleccionados.some(sel => sel.id === item.id)) {
      option.selected = true;
    }
    selectElement.appendChild(option);
  });
}

function getSelectValues(select) {
  const result = [];
  const options = select && select.options;
  for (let i = 0, len = options.length; i < len; i++) {
    const option = options[i];
    if (option.selected) {
      result.push(Number(option.value)); 
    }
  }
  return result;
}

  async function cargarDatosReserva() {
    try {
      const res = await fetch(`/api/reservas/${reservaId}`);
      if (!res.ok) throw new Error("No se pudo obtener la reserva");
      const reserva = await res.json();

    tipoReserva.value = reserva.tipoReserva;
    fechaHora.value = new Date(reserva.fechaHora).toISOString().split("T")[0];
    hora.value = new Date(reserva.fechaHora).toTimeString().slice(0,5);
    sucursal.value = reserva.sucursal.nombre;
    nombreSolicitante.value = reserva.solicitante?.nombre || "";
    correoSolicitante.value = reserva.solicitante?.correo || "";
    empresaSolicitante.value = reserva.empresa?.nombre || "";
  
     trabajadoresContainer.innerHTML = "";
      reserva.reservasTrabajador.forEach((rt, index) => {
        const div = document.createElement("div");
        div.className = "mb-3 trabajador-item";
        div.innerHTML = `
          <label>Nombre</label>
          <input type="text" class="form-control" name="nombreTrabajador" value="${rt.trabajador.nombre}" required>
          <label>RUT/Pasaporte</label>
          <input type="text" class="form-control" name="rutTrabajador" value="${rt.trabajador.rutPasaporte}" required>
          <label>Cargo</label>
          <input type="text" class="form-control" name="cargoTrabajador" value="${rt.cargo}" required>
          <label>Edad</label>
          <input type="number" class="form-control" name="edadTrabajador" value="${rt.edad}" required>
          <label>Correo</label>
          <input type="email" class="form-control" name="correoTrabajador" value="${rt.correo ?? ""}">
          <hr>
        `;
        trabajadoresContainer.appendChild(div);
      });

      await cargarOpcionesSelect("/api/baterias-medicas", bateriasMedicas, reserva.bateriasMedicas);
      await cargarOpcionesSelect("/api/examenes-adicionales", examenesAdicionales, reserva.examenesAdicionales);
      await cargarOpcionesSelect("/api/pruebas-drogas", pruebasDrogas, reserva.pruebasDrogas);

    } catch (err) {
      alert("Error al cargar la reserva");
      console.error(err);
    }
  }

document.getElementById("formEditarReserva").addEventListener("submit", async (e) => {
    e.preventDefault();
console.log("Formulario enviado");

const trabajadores = Array.from(document.querySelectorAll(".trabajador-item")).map(div => ({
  nombre: div.querySelector('[name="nombreTrabajador"]').value,
  rut: div.querySelector('[name="rutTrabajador"]').value,
  edad: div.querySelector('[name="edadTrabajador"]').value,
  cargo: div.querySelector('[name="cargoTrabajador"]').value,
  correo: div.querySelector('[name="correoTrabajador"]').value
}));

 const payload = {
      tipoReserva: tipoReserva.value,
      fechaHora: `${fechaHora.value}T${hora.value}`, 
      bateriasMedicas: getSelectValues(bateriasMedicas),
      examenesAdicionales: getSelectValues(examenesAdicionales),
      pruebasDrogas: getSelectValues(pruebasDrogas),
      trabajadores
    };
console.log("Payload a enviar:", payload);
try {
      const res = await fetch(`/api/reservas/${reservaId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (res.ok) {
        alert("Reserva actualizada correctamente.");
        window.location.href = "/";
      } else {
        alert(data.error || "Error al actualizar");
      }
    } catch (err) {
      alert("Error al enviar los datos");
      console.error(err);
    }
  });

document.getElementById("btnCancelar").addEventListener("click", () => {
  window.location.href = "index.html";

});
  cargarDatosReserva();

});
  </script>

